<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Munchkin Scorecard</title>
  <style type='text/css'>
    h2 { font-weight: normal; display: inline; font-size: 1.5em }
    ol, body { margin : 0; padding: 0; }
    li { background: #c00; height: 1.5em; list-style: none; padding: 0.2em 0.5em; clear: both; border-bottom: 1px solid rgba(216, 216,216,0.8); -webkit-transition: background 300ms, opacity 200ms; }
    li:odd { background: #008; }
    li span, .delete { float: right; vertical-align: middle; margin-top: 0.3333em; } 
    .winner { background: lime; }
    .winner span { display: none; }
    .winner h2:after { content: " Winner!"; font-size: 0.5em; color: white;text-transform: uppercase; }
    .loser { opacity: 0.5 }
    #add-player { display: none; }
   menu { box-sizing: border-box;background: #ccf; padding: 0.5em;margin:0; position: absolute; bottom: 0; left: 0; width: 100%; }
  </style>
</head>
<body>
  <ol id="players">Loading...</ol>
  
  <menu>
    <button id="edit-players">Edit Players</button>
    <button id="add-player">Add Player</button>
  </menu>
    
  <script type="text/template" id="player">
    <% if ( player.isEditing() ) { %>
    <input type="text" value="<%= player.get('name') %>">
    <button class="delete">Remove</button>
    <% } else { %>
    <h2><%= player.get('name') %></h2>
    <span>
      <button class="lvldn">-</button>
      <b><%= player.get('level') %></b>
      <button class="lvlup">+</butoton>
    </span>
    <% } %>
  </script>

  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.3/zepto.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js" type="text/javascript"></script>
  <script type="text/javascript">

var AppView = Backbone.View.extend({
  el: 'body',
  $list: this.$('#players'),
  events: {
    'click #add-player' : 'addPlayer',
    'click #edit-players' : 'editPlayers',
  },
  initialize: function(){
    var self = this;
    this.collection = new PlayerCollection();
    this.render();
    this.listenTo(this.collection, 'add remove', this.render);
    this.listenTo(this, 'change', this.render);
  },
  editPlayers: function(event){
    AppView.isEditing = !AppView.isEditing;
    this.collection.each(function(player){
      player.set('isEditing', AppView.isEditing);
    });
    $('#add-player').toggle();
    event.target.innerHTML = AppView.isEditing ? "Done Editing" : "Edit Players";
  },
  addPlayer: function(){
    this.collection.push(new Player({name: "Player " + (this.collection.length + 1)}));
  },
  render: function(){
    var self = this;
    this.$list.empty();
    this.collection.each(function(item){
      var playerView = new PlayerView({model:item});
      self.$list.append(playerView.render().el);
    });
  }

});

var PlayerView = Backbone.View.extend({
  tagName: 'li',
  template: _.template( $("#player").html() ),
  events: {
    'keyup input' : 'updateName',
    'click .lvlup': 'levelUp',
    'click .lvldn': 'levelDown',
    'click .delete': 'destroy'
  },
  initialize: function(){
    this.listenTo(this.model, 'change', this.render);
  },
  destroy: function(){
    appView.collection.remove(this.model);
    this.remove();
  },
  updateName: function(event){
    this.model.set('name', event.target.value);
  },
  levelUp: function(event){
    this.model.levelUp();
    if ( this.model.isWinner() ){
      event.delegateTarget.classList.add('winner');
      appView.$('li').not(this.el).addClass('loser');
    }
  },
  levelDown: function(event){
    this.model.levelDown();
  },
  render: function(){
    this.$el.html( this.template({player: this.model}) );
    this.$('.lvldn').toggle(!this.model.isAtMinLevel());
    return this;
  }
});

var Player = Backbone.Model.extend({
  defaults: {
    name: "Player 1",
    level: 1,
    bonus: 0,
    isEditing: AppView.isEditing
  },
  maxLevel: 10,
  minLevel: 1,
  isEditing: function(){
    return AppView.isEditing;
  },
  levelUp: function(){ this.set('level', Math.min(this.maxLevel, this.get('level') + 1)); },
  levelDown: function(){ this.set('level', Math.max(this.minLevel, this.get('level') - 1)); },
  isWinner: function(){ return this.get('level') >= this.maxLevel; },
  isAtMinLevel: function(){ return this.get('level') <= this.minLevel; }
});

var PlayerCollection = Backbone.Collection.extend({
  model: Player,
  initialize: function(){
    for (var i=1;i<=3;i++){
      this.push(new Player({name: "Player " + i}));
    }
  }
});

window.appView = new AppView();
</script>
</body>
</html>

