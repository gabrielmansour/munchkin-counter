<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
  <title>Munchkin Scorecard</title>
  <style type='text/css'>
    body { font-family: "Helvetica Neue", "Open Sans", Arial, Helvetica, sans-serif; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none }
    h2 { display: inline; line-height: 2em; font-weight: normal; }
    ol, body { margin : 0; padding: 0; }
    li { background: #c00; height: 3em; list-style: none; padding: 0.2em 0.5em; clear: both; border-bottom: 1px solid rgba(216, 216,216,0.8); -webkit-transition: background 300ms, opacity 200ms; position: relative; }
    li:odd { background: #008; }
    li b { padding: 0 1em; }
    li span, .delete, #toggle-die { float: right; vertical-align: middle; position: absolute; right: 0; top: 0; }
    span { font-size: 1.5em; line-height: 2em; height: 100%; }
    .winner { background: lime; }
    .winner span { display: none; }
    .winner h2:after { content: " Winner!"; font-size: 0.5em; color: white;text-transform: uppercase; }
    .loser { opacity: 0.5 }
    #add-player { display: none; }
    menu { box-sizing: border-box; background: #ccf; height: 3em; padding: 0; margin:0; position: absolute; bottom: 0; left: 0; width: 100%; }

    input, button { box-sizing: border-box; font: inherit; min-width: 2em; height: 100%; line-height: 200%; background-color: rgb(255,255,255); border: 2px solid rgba(0,0,0,0.8); }
    button { margin: 0; background-color: rgba(255,255,255,0.4); border: 0; cursor: pointer; }
    h2, input { font-size: 1.5em; }

    #dice {
      display: none;
      font-size: 6em;
      border-radius: 20%;
      border: 2px solid #333;
      padding: 0.5em;
      width: 1em;
      height: 1em;
      text-align: center;
      background-color: #fff;
      margin: 0.75em auto;
      cursor: pointer;
      line-height: 1;
    }
    #dice.rolling { opacity: 0.4; }
  </style>
</head>
<body>
  <ol id="players">Loading...</ol>
  <div id="dice">*</div>
  
  <menu>
    <button id="edit-players">Edit Players</button>
    <button id="add-player">+ Add Player</button>
    <button id="toggle-die">Dice</button>
  </menu>
    
  <script type="text/template" id="player">
    <% if ( player.isEditing() ) { %>
    <input type="text" value="<%= player.get('name') %>">
    <button class="delete">Remove</button>
    <% } else { %>
    <h2><%= player.get('name') %></h2>
    <span>
      <button class="lvldn">-</button>
      <b><%= player.get('level') %></b>
      <button class="lvlup">+</button>
    </span>
    <% } %>
  </script>

  <script src="http://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.3/zepto.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js" type="text/javascript"></script>
  <script type="text/javascript">

var AppView = Backbone.View.extend({
  el: 'body',
  $list: this.$('#players'),
  events: {
    'click #edit-players' : 'editPlayers',
    'click #add-player' : 'addPlayer',
    'click #toggle-die' : 'toggleDie'
  },
  initialize: function(){
    var self = this;
    this.diceView = new DiceView();
    this.collection = new PlayerCollection();
    this.render();
    this.listenTo(this.collection, 'add remove', this.render);
    this.listenTo(this, 'change', this.render);
  },
  editPlayers: function(event){
    AppView.isEditing = !AppView.isEditing;
    this.collection.each(function(player){
      player.set('isEditing', AppView.isEditing);
    });
    $('#add-player').toggle();
    event.target.innerHTML = AppView.isEditing ? "Done Editing" : "Edit Players";
  },
  addPlayer: function(){
    this.collection.push(new Player({name: "Player " + (this.collection.length + 1)}));
  },
  toggleDie: function(){
    $('#dice, #players').toggle();
  },
  render: function(){
    var self = this;
    this.$list.empty();
    this.collection.each(function(item){
      var playerView = new PlayerView({model:item});
      self.$list.append(playerView.render().el);
    });
  }

});

var PlayerView = Backbone.View.extend({
  tagName: 'li',
  template: _.template( $("#player").html() ),
  events: {
    'change input' : 'updateName',
    'click .lvlup': 'levelUp',
    'click .lvldn': 'levelDown',
    'click .delete': 'destroy'
  },
  initialize: function(){
    this.listenTo(this.model, 'change', this.render);
  },
  destroy: function(){
    appView.collection.remove(this.model);
    this.remove();
  },
  updateName: function(event){
    this.model.set('name', event.target.value);
  },
  levelUp: function(){
    this.model.levelUp();
    if ( this.model.isWinner() ){
      this.$el.addClass('winner')
        .siblings().addClass('loser').find('button').hide();
    }
  },
  levelDown: function(){
    this.model.levelDown();
  },
  render: function(){
    this.$el.html( this.template({player: this.model}) );
    this.$('.lvldn').toggle(!this.model.isAtMinLevel());
    return this;
  }
});

var Player = Backbone.Model.extend({
  defaults: {
    name: "Player 1",
    level: 1,
    bonus: 0,
    isEditing: AppView.isEditing
  },
  minLevel: 1,
  maxLevel: 10,
  levelUp: function(){ this.set('level', Math.min(this.maxLevel, this.get('level') + 1)); },
  levelDown: function(){ this.set('level', Math.max(this.minLevel, this.get('level') - 1)); },
  isWinner: function(){ return this.get('level') >= this.maxLevel; },
  isAtMinLevel: function(){ return this.get('level') <= this.minLevel; },
  isEditing: function(){ return AppView.isEditing; }
});

var PlayerCollection = Backbone.Collection.extend({
  model: Player,
  initialize: function(){
    for (var i=1;i<=3;i++){
      this.push(new Player({name: "Player " + i}));
    }
  }
});

var Dice = Backbone.Model.extend({
  // only changes value once
  roll: function(){
    this.set('value', this.getRandomValue());
  },
  getRandomValue: function(){
    return Math.ceil(Math.random() * 6);
  }
});

var DiceView = Backbone.View.extend({
  el: '#dice',
  ROLLING_CLASSNAME: 'rolling',
  events: {
    'click' : 'roll'
  },
  initialize: function(){
    this.model = new Dice();
    this.listenTo(this.model, 'change', this.render);
  },

  roll: function(){
    this.$el.addClass(this.ROLLING_CLASSNAME);
    for (var i = 1, timeout, d = 50, self = this; i <= d; i++){
      timeout = i * i;
      setTimeout((function(n){
        return function() {
          self.model.roll();
          if (n==d){
            self.$el.removeClass(self.ROLLING_CLASSNAME);
          }
        };
      }(i)), timeout);
    }
  },
  render: function(){
    this.el.innerHTML = this.model.get('value');
    return this;
  }
});

window.appView = new AppView();
</script>
</body>
</html>

